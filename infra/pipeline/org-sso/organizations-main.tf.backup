terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
  required_version = ">= 1.8.0"
}

# Management Account Provider
provider "aws" {
  region = var.region # Organizations must be in us-east-1

  # Skip role assumption if credentials are already from an assumed role
  # This prevents circular role assumption when running in CI/CD or with SSO
  skip_metadata_api_check     = true
  skip_credentials_validation = true
}

# Create Development Account (only if it doesn't exist)
resource "aws_organizations_account" "development" {
  count = length([
    for account in data.aws_organizations_accounts.existing.children :
    account if account.email == var.development_email
  ]) == 0 ? 1 : 0

  name      = "Magebase Development"
  email     = var.development_email
  role_name = "OrganizationAccountAccessRole"

  # Optional: Add to specific OU
  parent_id = local.development_ou_id

  tags = {
    Environment = "Development"
    Project     = "Magebase"
  }
}

# Create Production Account (only if it doesn't exist)
resource "aws_organizations_account" "production" {
  count = length([
    for account in data.aws_organizations_accounts.existing.children :
    account if account.email == var.production_email
  ]) == 0 ? 1 : 0

  name      = "Magebase Production"
  email     = var.production_email
  role_name = "OrganizationAccountAccessRole"

  # Optional: Add to specific OU
  parent_id = local.production_ou_id

  tags = {
    Environment = "Production"
    Project     = "Magebase"
  }
}

# Get existing Organizational Units
data "aws_organizations_organizational_units" "existing" {
  parent_id = data.aws_organizations_organization.main.roots[0].id
}

# Create Organizational Units (only if they don't exist)
resource "aws_organizations_organizational_unit" "development" {
  count = length([
    for ou in data.aws_organizations_organizational_units.existing.children :
    ou if ou.name == "Development"
  ]) == 0 ? 1 : 0

  name      = "Development"
  parent_id = data.aws_organizations_organization.main.roots[0].id
}

resource "aws_organizations_organizational_unit" "production" {
  count = length([
    for ou in data.aws_organizations_organizational_units.existing.children :
    ou if ou.name == "Production"
  ]) == 0 ? 1 : 0

  name      = "Production"
  parent_id = data.aws_organizations_organization.main.roots[0].id
}

# Use existing OUs if they exist, otherwise use the created ones
locals {
  development_ou_id = length([
    for ou in data.aws_organizations_organizational_units.existing.children :
    ou if ou.name == "Development"
  ]) > 0 ? [
    for ou in data.aws_organizations_organizational_units.existing.children :
    ou.id if ou.name == "Development"
  ][0] : aws_organizations_organizational_unit.development[0].id

  production_ou_id = length([
    for ou in data.aws_organizations_organizational_units.existing.children :
    ou if ou.name == "Production"
  ]) > 0 ? [
    for ou in data.aws_organizations_organizational_units.existing.children :
    ou.id if ou.name == "Production"
  ][0] : aws_organizations_organizational_unit.production[0].id
}

# Reference existing organization (don't create if it exists)
data "aws_organizations_organization" "main" {}

# Output the account IDs for use in SSO configuration
output "development_account_id" {
  description = "AWS Account ID for the development account"
  value = length([
    for account in data.aws_organizations_accounts.existing.children :
    account if account.email == var.development_email
  ]) > 0 ? [
    for account in data.aws_organizations_accounts.existing.children :
    account.id if account.email == var.development_email
  ][0] : aws_organizations_account.development[0].id
}

output "production_account_id" {
  description = "AWS Account ID for the production account"
  value = length([
    for account in data.aws_organizations_accounts.existing.children :
    account if account.email == var.production_email
  ]) > 0 ? [
    for account in data.aws_organizations_accounts.existing.children :
    account.id if account.email == var.production_email
  ][0] : aws_organizations_account.production[0].id
}
